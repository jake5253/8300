window.RAINIER=window.RAINIER||{};RAINIER.setup.resendEmailButtonVisible=false;var username,checks={},requireUpdate=false;function handleError(a){var b={};try{b.result=JSON.parse(a.responseText).errors[0].error.code}catch(c){}if((a.status===409&&a.statusText==="Conflict")||(a.status===404&&a.statusText==="Not Found")){if(b.result==="PASSWORD_REUSED"){showGeneralError(RAINIER.login.strings.changePasswordReusedPassword);showView("newPassword")}else{if(b.result==="PASSWORD_COMPLEXITY_ERROR"){showGeneralError(RAINIER.createAccount.strings.passwordRequirementsMessage);showView("newPassword")}else{showGeneralError()}}}else{if(b.result==="INVALID_CURRENT_PASSWORD"){RAINIER.ui.inputBalloon.message({message:RAINIER.ui.myAccountStrings.errorChangingPassword,els:$("#currentPassword"),autoHide:true});showView("newPassword")}else{if(a.status===400&&a.statusText==="Bad Request"){showGeneralError();showEmailView()}else{RAINIER.shared.ui.showGenericError()}}}}function deleteCookies(){$.cookie("user-auth-token",null,{path:"/"});$.cookie("user-email",null,{path:"/"})}function simpleInputValidation(){var a=true;if(requireUpdate){a=checks.currentPassword.isValid(true);if(!a){$("#currentPassword").blur();$("#currentPassword").focus()}}if(a){a=checks.password.isValid();if(!a){checks.password.isValid(true);$("#password").blur();$("#password").focus()}}if(a){a=checks.passwordConfirm.isValid(true);if(!a){$("#passwordConfirm").blur();$("#passwordConfirm").focus()}}return a}function sendEmailFailed(b,a){document.getElementById("emailInput").focus();showView("email");if(b){RAINIER.setup.resendEmailButtonVisible=false;switch(b){case RAINIER.simple.account.errorCode.ACCOUNT_LOCKED_OUT:window.location.href="/ui/dynamic/setup/account-lockout-simple.html";break;case RAINIER.simple.account.errorCode.ACCOUNT_SECURITY_LOCK:window.location.href="/ui/dynamic/setup/account-security-lock-simple.html";break;case RAINIER.simple.account.errorCode.ACCOUNT_DISABLED:showInputValidationError("emailInputValidation",true,RAINIER.login.strings.accountDisabled.replace("{username}",a));break;case RAINIER.simple.account.errorCode.ACCOUNT_PENDING:showInputValidationError("emailInputValidation",true,RAINIER.login.strings.accountPending);document.getElementById("resendEmailButton").style.display="block";RAINIER.setup.resendEmailButtonVisible=true;break;case RAINIER.simple.account.errorCode.INVALID_PARAMETER:case RAINIER.simple.account.errorCode.INVALID_ACCOUNT_CREDENTIALS:case RAINIER.simple.account.errorCode.ACCOUNT_NOT_FOUND:showInputValidationError("emailInputValidation",true,RAINIER.login.strings.accountNotFound.replace("{username}",a));break;default:showGeneralError(RAINIER.login.strings.unexpectedCloudError);break}}}function sendEmailRequest(a,b){var c=document.getElementById("emailInput").value;if(c.length===0){showInputValidationError("emailInputValidation",true,RAINIER.setup.ui.inputRequired);return}else{if(!RAINIER.shared.util.isValidEmail(c)){showInputValidationError("emailInputValidation",true,RAINIER.setup.ui.invalidEmail);return}}showView("verifyingEmail");clearAllInputErrors();RAINIER.cloud.send({url:a,data:b,type:"POST",request:{},cb:function(){$.cookie("user-email",c,{path:"/"});showView("emailVerified")},cbError:function(d){RAINIER.simple.account.getErrorCode(d,function(e){sendEmailFailed(e,c)})}})}function sendEmail(){var b=RAINIER.shared.util.getURLParameter("callback");var a="/cloud/user-service/rest/accounts/"+document.getElementById("emailInput").value+"/passwordresets";if(b){a=a+"?caller="+b}sendEmailRequest(a)}function resendEmail(){sendEmailRequest("/cloud/user-service/rest/verifications",{verification:{type:"ACCOUNT_CREATION",parameters:[{parameter:{name:"username",value:document.getElementById("emailInput").value}}]}})}function submitPassword(){var g=document.getElementById("password").value,b=document.getElementById("passwordConfirm").value;function c(){$.cookie("user-auth-token",null,{path:"/"});$.cookie("user-email",null,{path:"/"});if(requireUpdate){window.location.replace("login-simple.html")}else{showView("passwordChanged")}}if(!simpleInputValidation()){return}showView("verifyingPassword");clearAllInputErrors();if(requireUpdate){var e=RAINIER.shared.util.getURLParameter("verificationToken");$.cookie("user-auth-token",e,{path:"/"});RAINIER.cloud.send({url:"/cloud/user-service/rest/v2/accounts/self/passwordchanges",type:"POST",data:{passwordChange:{newPassword:$("#password").val(),currentPassword:$("#currentPassword").val()}},cb:function(i,h){if(h.status!==200){handleError(h)}else{RAINIER.network.deleteUserSession(c,e)}},cbError:handleError})}else{var a={};a.parameter={};a.parameter.name="password";a.parameter.value=g;var f={};f.verification={};f.verification.status="ACCEPTED";f.verification.parameters=[];f.verification.parameters.push(a);var d=RAINIER.shared.util.getURLParameter("callback");RAINIER.cloud.send({url:"/cloud/user-service/rest/v2/verifications/"+RAINIER.shared.util.getURLParameter("verificationToken")+"/status/",type:"PUT",data:f,cb:function(){if(d){showGeneralMessage(RAINIER.ui.myAccountStrings.successMessage.replace("{url}",d))}else{showGeneralMessage(RAINIER.ui.myAccountStrings.successMessageNoCallback)}c()},cbError:handleError})}}function showEmailView(){showView("email");if(!RAINIER.setup.resendEmailButtonVisible){document.getElementById("resendEmailButton").style.display="none"}if(username){document.getElementById("emailInput").value=username}}window.onload=function(){document.getElementById("sendEmailButton").onclick=sendEmail;document.getElementById("resendEmailButton").onclick=resendEmail;document.getElementById("submitPasswordButton").onclick=submitPassword;requireUpdate=RAINIER.shared.util.getURLParameter("req")==="1";function a(){var f=RAINIER.shared.util.getURLParameter("verificationToken");username=RAINIER.shared.util.getURLParameter("username");if(!f){showEmailView()}else{var c=RAINIER.ui.buildInputValidBalloon;$("#usernameHidden").val($.cookie("user-email"));checks.currentPassword=c($.extend(true,{},{els:$("#currentPassword"),isBlankOnBlur:false},validation.ruleSet.cloudAccountPassword));checks.password=c($.extend(true,{},{els:$("#password"),validationType:"newCloudPassword",isChecklist:true,noWarnIcon:true},RAINIER.network.getCloudAccountNewPasswordOptions()));checks.passwordConfirm=c({els:$("#passwordConfirm"),validationType:"confirmPassword",elCompareTo:$("#password")});if(requireUpdate){showView("requireUpdate");$(".notRequireUpdate").hide()}else{showView("newPassword")}try{document.getElementById("newPassword").focus()}catch(d){}}}var b=RAINIER.shared.util.getURLParameter("lang");if(b){RAINIER.shared.ui.reviewHtmlLang(b,a)}else{a()}};$(window).bind("beforeunload",function(){$.cookie("user-auth-token",null,{path:"/"})});